#!/usr/bin/env bash
#
# Dotfiles Resume Script
# Handles automatic installation resume after macOS restarts
#
# Usage:
#   bin/dotfiles-resume setup    # Set up automatic resume mechanism
#   bin/dotfiles-resume run      # Run resume (called automatically)
#   bin/dotfiles-resume cleanup  # Clean up resume mechanism
#

set -e

# Configuration
DOTFILES_DIR="$HOME/.dotfiles"
INSTALL_LOG="$HOME/.dotfiles-install.log"
PLIST_FILE="$HOME/Library/LaunchAgents/com.dotfiles.resume.plist"
COMPLETION_FILE="$HOME/.dotfiles-installation-complete"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$INSTALL_LOG"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}" | tee -a "$INSTALL_LOG"
}

warn() {
    echo -e "${YELLOW}âš ï¸  $1${NC}" | tee -a "$INSTALL_LOG"
}

# Open terminal window for installation
open_terminal_for_installation() {
    local script_to_run="$1"

    # Check if Hyper is installed and available
    if command -v hyper &> /dev/null || [ -d "/Applications/Hyper.app" ]; then
        log "Opening Hyper terminal for installation..."
        # Use Hyper to run the script
        if [ -d "/Applications/Hyper.app" ]; then
            open -a "Hyper" --args -e "$script_to_run"
        else
            # If hyper command exists, use it
            hyper -e "$script_to_run" &
        fi
    else
        log "Opening Terminal.app for installation..."
        # Use built-in Terminal.app
        osascript << EOF
tell application "Terminal"
    activate
    do script "$script_to_run"
end tell
EOF
    fi
}

# Show usage
show_usage() {
    echo "dotfiles-resume -- Handle automatic installation resume"
    echo ""
    echo "Usage: dotfiles-resume [command]"
    echo ""
    echo "Commands:"
    echo "  setup    Set up automatic resume mechanism for macOS restarts"
    echo "  run      Run resume process (called automatically after restart)"
    echo "  cleanup  Remove resume mechanism when installation complete"
    echo "  status   Show current resume status"
    exit 0
}

# Set up automatic resume mechanism
setup_resume() {
    log "Setting up automatic resume mechanism..."

    # Ensure LaunchAgents directory exists
    mkdir -p "$(dirname "$PLIST_FILE")"

    # Create launch agent
    cat > "$PLIST_FILE" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.dotfiles.resume</string>
    <key>ProgramArguments</key>
    <array>
        <string>$DOTFILES_DIR/bin/dotfiles-resume</string>
        <string>run</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardErrorPath</key>
    <string>$HOME/.dotfiles-resume-error.log</string>
    <key>StandardOutPath</key>
    <string>$HOME/.dotfiles-resume-output.log</string>
</dict>
</plist>
EOF

    # Load the launch agent
    launchctl load "$PLIST_FILE" 2>/dev/null || true

    success "Resume mechanism set up successfully"
}

# Run the resume process
run_resume() {
    log "Checking if resume is needed..."

    # Check if installation is already complete
    if [ -f "$COMPLETION_FILE" ]; then
        log "Installation already complete, cleaning up..."
        cleanup_resume
        success "Resume mechanism cleaned up"
        exit 0
    fi

    # Check if dotfiles directory exists
    if [ ! -d "$DOTFILES_DIR" ]; then
        warn "Dotfiles directory not found, resume not needed"
        exit 0
    fi

    log "Resuming dotfiles installation after restart..."

    # Create a completion script that will be run in the terminal
    local completion_script="$DOTFILES_DIR/bin/dotfiles-installation-complete"
    cat > "$completion_script" << 'EOF'
#!/usr/bin/env bash
# This script is run after the installation completes in the terminal

COMPLETION_FILE="$HOME/.dotfiles-installation-complete"
DOTFILES_DIR="$HOME/.dotfiles"

# Mark installation as complete
touch "$COMPLETION_FILE"
echo "âœ… Dotfiles installation completed successfully!"

# Clean up resume mechanism
"$DOTFILES_DIR/bin/dotfiles-resume" cleanup

echo ""
echo "ğŸ‰ Installation Summary:"
echo "  â€¢ Dotfiles successfully installed"
echo "  â€¢ Resume mechanism cleaned up"
echo ""
echo "ğŸš€ Next steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. Run 'dotfiles-registry summary' to see available tools"
echo "  3. Run 'bin/dot' anytime to update"
echo ""
echo "Press any key to close this terminal..."
read -n 1
EOF
    chmod +x "$completion_script"

    # Open terminal window to run the installation interactively
    log "Opening terminal window for interactive installation..."
    open_terminal_for_installation "cd '$DOTFILES_DIR' && bin/dot && '$completion_script'"

    # Exit the LaunchAgent - the terminal window will handle completion
    log "Terminal opened for installation. LaunchAgent task complete."
    exit 0
}

# Clean up resume mechanism
cleanup_resume() {
    log "Cleaning up resume mechanism..."

    # Remove launch agent
    if [ -f "$PLIST_FILE" ]; then
        launchctl unload "$PLIST_FILE" 2>/dev/null || true
        rm -f "$PLIST_FILE"
    fi

    # Remove completion marker
    rm -f "$COMPLETION_FILE"

    # Clean up log files and temporary scripts
    rm -f "$HOME/.dotfiles-resume-error.log"
    rm -f "$HOME/.dotfiles-resume-output.log"
    rm -f "$DOTFILES_DIR/bin/dotfiles-installation-complete"

    success "Resume mechanism cleaned up"
}

# Show resume status
show_status() {
    echo "ğŸ“Š Dotfiles Resume Status:"
    echo ""

    if [ -f "$COMPLETION_FILE" ]; then
        echo "  âœ… Installation: Complete"
    else
        echo "  ğŸ”„ Installation: In Progress"
    fi

    if [ -f "$PLIST_FILE" ]; then
        echo "  ğŸš€ Resume Agent: Active"
        if launchctl list | grep -q "com.dotfiles.resume"; then
            echo "  ğŸ“¡ Launch Status: Loaded"
        else
            echo "  ğŸ“¡ Launch Status: Not Loaded"
        fi
    else
        echo "  ğŸš€ Resume Agent: Not Set Up"
    fi

    if [ -d "$DOTFILES_DIR" ]; then
        echo "  ğŸ“ Dotfiles: Present ($DOTFILES_DIR)"
    else
        echo "  ğŸ“ Dotfiles: Missing"
    fi

    echo "  ğŸ“‹ Install Log: $INSTALL_LOG"
}

# Handle command line arguments
case "${1:-}" in
    "setup")
        setup_resume
        ;;
    "run")
        run_resume
        ;;
    "cleanup")
        cleanup_resume
        ;;
    "status")
        show_status
        ;;
    ""|"-h"|"--help")
        show_usage
        ;;
    *)
        echo "Unknown command: $1"
        show_usage
        ;;
esac