#!/usr/bin/env bash
#
# Dotfiles Resume Script
# Handles automatic installation resume after macOS restarts
#
# Usage:
#   bin/dotfiles-resume setup    # Set up automatic resume mechanism
#   bin/dotfiles-resume run      # Run resume (called automatically)
#   bin/dotfiles-resume cleanup  # Clean up resume mechanism
#

set -e

# Configuration
DOTFILES_DIR="$HOME/.dotfiles"
INSTALL_LOG="$HOME/.dotfiles-install.log"
PLIST_FILE="$HOME/Library/LaunchAgents/com.dotfiles.resume.plist"
COMPLETION_FILE="$HOME/.dotfiles-installation-complete"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$INSTALL_LOG"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}" | tee -a "$INSTALL_LOG"
}

warn() {
    echo -e "${YELLOW}âš ï¸  $1${NC}" | tee -a "$INSTALL_LOG"
}

# Show usage
show_usage() {
    echo "dotfiles-resume -- Handle automatic installation resume"
    echo ""
    echo "Usage: dotfiles-resume [command]"
    echo ""
    echo "Commands:"
    echo "  setup    Set up automatic resume mechanism for macOS restarts"
    echo "  run      Run resume process (called automatically after restart)"
    echo "  cleanup  Remove resume mechanism when installation complete"
    echo "  status   Show current resume status"
    exit 0
}

# Set up automatic resume mechanism
setup_resume() {
    log "Setting up automatic resume mechanism..."

    # Ensure LaunchAgents directory exists
    mkdir -p "$(dirname "$PLIST_FILE")"

    # Create launch agent
    cat > "$PLIST_FILE" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.dotfiles.resume</string>
    <key>ProgramArguments</key>
    <array>
        <string>$DOTFILES_DIR/bin/dotfiles-resume</string>
        <string>run</string>
    </array>
    <key>RunAtLoad</key>
    <true/>
    <key>StandardErrorPath</key>
    <string>$HOME/.dotfiles-resume-error.log</string>
    <key>StandardOutPath</key>
    <string>$HOME/.dotfiles-resume-output.log</string>
</dict>
</plist>
EOF

    # Load the launch agent
    launchctl load "$PLIST_FILE" 2>/dev/null || true

    success "Resume mechanism set up successfully"
}

# Run the resume process
run_resume() {
    log "Checking if resume is needed..."

    # Check if installation is already complete
    if [ -f "$COMPLETION_FILE" ]; then
        log "Installation already complete, cleaning up..."
        cleanup_resume
        success "Resume mechanism cleaned up"
        exit 0
    fi

    # Check if dotfiles directory exists
    if [ ! -d "$DOTFILES_DIR" ]; then
        warn "Dotfiles directory not found, resume not needed"
        exit 0
    fi

    log "Resuming dotfiles installation after restart..."

    # Change to dotfiles directory and run dot
    cd "$DOTFILES_DIR"

    # Run the main installation
    log "Running bin/dot..."
    bin/dot

    # Check if we need another restart (macOS updates pending)
    if softwareupdate -l 2>/dev/null | grep -q "restart"; then
        warn "macOS updates require restart, will resume after reboot..."
        log "Scheduling restart in 60 seconds..."

        # Schedule restart
        sudo shutdown -r +1 "Restarting for macOS updates. Dotfiles installation will resume automatically." 2>/dev/null || {
            warn "Could not schedule restart automatically. Please restart manually."
        }
        exit 0
    fi

    # Mark installation as complete
    touch "$COMPLETION_FILE"
    success "Dotfiles installation completed successfully!"

    # Clean up resume mechanism
    cleanup_resume

    log "Installation complete! Please restart your terminal or run: source ~/.zshrc"
}

# Clean up resume mechanism
cleanup_resume() {
    log "Cleaning up resume mechanism..."

    # Remove launch agent
    if [ -f "$PLIST_FILE" ]; then
        launchctl unload "$PLIST_FILE" 2>/dev/null || true
        rm -f "$PLIST_FILE"
    fi

    # Remove completion marker
    rm -f "$COMPLETION_FILE"

    # Clean up log files
    rm -f "$HOME/.dotfiles-resume-error.log"
    rm -f "$HOME/.dotfiles-resume-output.log"

    success "Resume mechanism cleaned up"
}

# Show resume status
show_status() {
    echo "ğŸ“Š Dotfiles Resume Status:"
    echo ""

    if [ -f "$COMPLETION_FILE" ]; then
        echo "  âœ… Installation: Complete"
    else
        echo "  ğŸ”„ Installation: In Progress"
    fi

    if [ -f "$PLIST_FILE" ]; then
        echo "  ğŸš€ Resume Agent: Active"
        if launchctl list | grep -q "com.dotfiles.resume"; then
            echo "  ğŸ“¡ Launch Status: Loaded"
        else
            echo "  ğŸ“¡ Launch Status: Not Loaded"
        fi
    else
        echo "  ğŸš€ Resume Agent: Not Set Up"
    fi

    if [ -d "$DOTFILES_DIR" ]; then
        echo "  ğŸ“ Dotfiles: Present ($DOTFILES_DIR)"
    else
        echo "  ğŸ“ Dotfiles: Missing"
    fi

    echo "  ğŸ“‹ Install Log: $INSTALL_LOG"
}

# Handle command line arguments
case "${1:-}" in
    "setup")
        setup_resume
        ;;
    "run")
        run_resume
        ;;
    "cleanup")
        cleanup_resume
        ;;
    "status")
        show_status
        ;;
    ""|"-h"|"--help")
        show_usage
        ;;
    *)
        echo "Unknown command: $1"
        show_usage
        ;;
esac