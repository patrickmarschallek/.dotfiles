#!/usr/bin/env bash
#
# Dotfiles Registry - Discover all available tools, aliases, and functions
#

set -e

DOTFILES_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
ACTION="${1:-help}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

case "$ACTION" in
    "aliases")
        echo -e "${CYAN}üìã All Available Aliases${NC}"
        echo "=========================="
        echo ""

        # Group aliases by category
        echo -e "${YELLOW}üç∫ Homebrew Package Management${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias brew" {} \; | sort | sed 's/^/  /'

        echo ""
        echo -e "${YELLOW}üê≥ Container Development (Colima)${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias clm" {} \; | sort | sed 's/^/  /'

        echo ""
        echo -e "${YELLOW}ü§ñ AI Development Tools${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias \(cc\|ollama\|webui\|ai-\)" {} \; | sort | sed 's/^/  /'

        echo ""
        echo -e "${YELLOW}üîê Security & GPG${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias \(gpg\|pubkey\)" {} \; | sort | sed 's/^/  /'

        echo ""
        echo -e "${YELLOW}üë• Work-Specific (Company)${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias \(evan\|marouan\|max\|mayuri\|milad\|sergei\|siamand\)" {} \; | sort | sed 's/^/  /'
        ;;

    "functions")
        echo -e "${CYAN}üîß All Available Functions${NC}"
        echo "=========================="
        echo ""

        echo -e "${YELLOW}üç∫ Homebrew Management${NC}"
        echo "  brew-help()              - Show homebrew helper commands"
        echo "  brew-install-missing()   - Interactive install of missing applications"
        echo "  brew-lock()              - Manage Brewfile.lock.json"
        echo "  brew-status()            - Show Brewfile statistics and status"

        echo ""
        echo -e "${YELLOW}üê≥ Container Development${NC}"
        echo "  clm-help()               - Show colima helper commands"
        echo "  clm-quick-start()        - Quick start colima with default resources"
        echo "  clm-recreate-light()     - Recreate VM with light resources (2 CPU, 4GB)"
        echo "  clm-restart()            - Restart colima profile"
        echo "  clm-upgrade-quick()      - Quick upgrade colima"
        echo "  clm-use()                - Switch Docker context"

        echo ""
        echo -e "${YELLOW}ü§ñ AI Development${NC}"
        echo "  ai-start()               - Start complete AI environment (Ollama + WebUI)"
        echo "  ai-stop()                - Stop all AI services"
        echo "  ai-status()              - Show comprehensive AI tools status"
        echo "  ai-pull()                - Download AI models"
        echo "  ai-chat()                - Start interactive chat with model"
        echo "  ai-dev()                 - Show AI development workflow"
        echo "  ai-help()                - Show AI tools helper commands"
        ;;

    "helpers")
        echo -e "${CYAN}üõ†Ô∏è All Helper Scripts${NC}"
        echo "======================"
        echo ""

        echo -e "${YELLOW}üê≥ Colima Container Management${NC}"
        find "$DOTFILES_ROOT/04_colima/helpers" -name "*.sh" -exec basename {} \; | sort | sed 's/^/  /' | sed 's/.sh$//'

        echo ""
        echo -e "${YELLOW}ü§ñ AI Development Tools${NC}"
        find "$DOTFILES_ROOT/08_ai_tools/helpers" -name "*.sh" -exec basename {} \; | sort | sed 's/^/  /' | sed 's/.sh$//'
        ;;

    "tools")
        echo -e "${CYAN}üéØ Installed Development Tools${NC}"
        echo "=============================="
        echo ""

        echo -e "${YELLOW}üç∫ Package Managers${NC}"
        command -v brew >/dev/null && echo "  ‚úÖ Homebrew: $(brew --version | head -1)" || echo "  ‚ùå Homebrew: Not installed"

        echo ""
        echo -e "${YELLOW}üê≥ Container Runtime${NC}"
        command -v colima >/dev/null && echo "  ‚úÖ Colima: $(colima version 2>/dev/null | head -1 || echo 'installed')" || echo "  ‚ùå Colima: Not installed"
        command -v docker >/dev/null && echo "  ‚úÖ Docker: $(docker --version)" || echo "  ‚ùå Docker: Not installed"

        echo ""
        echo -e "${YELLOW}ü§ñ AI Development${NC}"
        command -v claude-code >/dev/null && echo "  ‚úÖ Claude Code: $(claude-code --version 2>/dev/null || echo 'installed')" || echo "  ‚ùå Claude Code: Not installed"
        command -v ollama >/dev/null && echo "  ‚úÖ Ollama: $(ollama --version 2>/dev/null || echo 'installed')" || echo "  ‚ùå Ollama: Not installed"
        docker ps --format "table {{.Names}}" 2>/dev/null | grep -q "open-webui" && echo "  ‚úÖ Open WebUI: Running (container)" || echo "  ‚ùå Open WebUI: Not running"

        echo ""
        echo -e "${YELLOW}‚òï Java Development${NC}"
        command -v jenv >/dev/null && echo "  ‚úÖ jenv: $(jenv --version)" || echo "  ‚ùå jenv: Not installed"
        if command -v jenv >/dev/null 2>&1; then
            echo "  üì¶ Java versions:"
            jenv versions 2>/dev/null | sed 's/^/    /' || echo "    No versions configured"
        fi

        echo ""
        echo -e "${YELLOW}üêç Python Development${NC}"
        command -v pyenv >/dev/null && echo "  ‚úÖ pyenv: $(pyenv --version)" || echo "  ‚ùå pyenv: Not installed"
        command -v pipenv >/dev/null && echo "  ‚úÖ pipenv: $(pipenv --version)" || echo "  ‚ùå pipenv: Not installed"
        command -v poetry >/dev/null && echo "  ‚úÖ poetry: $(poetry --version)" || echo "  ‚ùå poetry: Not installed"

        echo ""
        echo -e "${YELLOW}üåê Node.js Development${NC}"
        command -v node >/dev/null && echo "  ‚úÖ Node.js: $(node --version)" || echo "  ‚ùå Node.js: Not installed"
        command -v npm >/dev/null && echo "  ‚úÖ npm: $(npm --version)" || echo "  ‚ùå npm: Not installed"
        command -v nvm >/dev/null && echo "  ‚úÖ nvm: $(nvm --version 2>/dev/null || echo 'installed')" || echo "  ‚ùå nvm: Not installed"
        ;;

    "search")
        SEARCH_TERM="${2}"
        if [ -z "$SEARCH_TERM" ]; then
            echo "Usage: $0 search <term>"
            exit 1
        fi

        echo -e "${CYAN}üîç Searching for: ${YELLOW}$SEARCH_TERM${NC}"
        echo "================================"
        echo ""

        echo -e "${PURPLE}Aliases:${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias.*$SEARCH_TERM" {} \; | sed 's/^/  /' || echo "  No matches found"

        echo ""
        echo -e "${PURPLE}Functions:${NC}"
        find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^[a-zA-Z_-]*$SEARCH_TERM.*() {" {} \; | sed 's/^/  /' || echo "  No matches found"

        echo ""
        echo -e "${PURPLE}Helper Scripts:${NC}"
        find "$DOTFILES_ROOT" -name "*$SEARCH_TERM*.sh" | sed 's/^/  /' || echo "  No matches found"
        ;;

    "summary")
        echo -e "${CYAN}üìä Dotfiles Summary${NC}"
        echo "==================="
        echo ""

        ALIAS_COUNT=$(find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^alias " {} \; | wc -l | tr -d ' ')
        FUNCTION_COUNT=$(find "$DOTFILES_ROOT" -name "*.zsh" -exec grep -h "^[a-zA-Z_-]*() {" {} \; | wc -l | tr -d ' ')
        HELPER_COUNT=$(find "$DOTFILES_ROOT" -name "*.sh" -path "*/helpers/*" | wc -l | tr -d ' ')
        COMPONENT_COUNT=$(find "$DOTFILES_ROOT" -maxdepth 1 -name "[0-9]*" -type d | wc -l | tr -d ' ')

        echo -e "${GREEN}üìã Total Aliases: $ALIAS_COUNT${NC}"
        echo -e "${GREEN}üîß Total Functions: $FUNCTION_COUNT${NC}"
        echo -e "${GREEN}üõ†Ô∏è Helper Scripts: $HELPER_COUNT${NC}"
        echo -e "${GREEN}üìÅ Components: $COMPONENT_COUNT${NC}"
        echo ""
        echo -e "${YELLOW}Quick Access:${NC}"
        echo "  dotfiles-registry aliases   - List all aliases"
        echo "  dotfiles-registry functions - List all functions"
        echo "  dotfiles-registry helpers   - List all helper scripts"
        echo "  dotfiles-registry tools     - Show installed tools status"
        echo "  dotfiles-registry search X  - Search for X in aliases/functions"
        ;;

    "help"|*)
        echo -e "${CYAN}üéØ Dotfiles Registry${NC}"
        echo "===================="
        echo ""
        echo "Discover and manage all available tools, aliases, and functions in your dotfiles."
        echo ""
        echo -e "${YELLOW}Usage:${NC} $(basename "$0") <command>"
        echo ""
        echo -e "${YELLOW}Commands:${NC}"
        echo "  aliases     List all available aliases grouped by category"
        echo "  functions   List all available functions grouped by category"
        echo "  helpers     List all helper scripts"
        echo "  tools       Show status of all installed development tools"
        echo "  search <term>  Search for aliases, functions, or scripts"
        echo "  summary     Show overview statistics"
        echo "  help        Show this help"
        echo ""
        echo -e "${YELLOW}Examples:${NC}"
        echo "  $(basename "$0") summary          # Quick overview"
        echo "  $(basename "$0") aliases          # List all aliases"
        echo "  $(basename "$0") search docker    # Find docker-related items"
        echo "  $(basename "$0") tools            # Check tool installation status"
        ;;
esac