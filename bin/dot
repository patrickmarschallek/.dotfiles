#!/usr/bin/env bash
#
# dot
#
# `dot` handles installation, updates, things like that. Run it periodically
# to make sure you're on the latest and greatest.

set -e

parentDirectory="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P)"
dotfilesDirectory="$(cd "$( dirname "$parentDirectory" )" && pwd -P)"

displayUsageAndExit() {
	echo "dot -- dotfiles management"
	echo ""
	echo "Usage: dot [options]"
	echo ""
	echo "Options:"
	echo "  -e, --edit    Open dotfiles directory for editing"
	echo "  -h, --help    Show this help message and exit"
	exit
}

while test $# -gt 0; do
	case "$1" in
		"-h"|"--help")
			displayUsageAndExit
			;;
		"-e"|"--edit")
			exec "$EDITOR" "$dotfilesDirectory"
			exit
			;;
		*)
			echo "Invalid option: $1"
			displayUsageAndExit
			;;
	esac
	shift
done

export DOTFILES=$HOME/.dotfiles

# Set macOS defaults
echo "› setting macOS defaults"
if ! $DOTFILES/00_macos/set-defaults.sh; then
    echo "⚠️  macOS defaults setup failed, continuing anyway"
fi

# Install homebrew
echo "› installing/updating homebrew"
HOMEBREW_DIR=$DOTFILES/01_homebrew
if ! $HOMEBREW_DIR/install.sh 2>&1; then
    echo "⚠️  homebrew installation failed, trying to continue"
fi

# Upgrade homebrew
echo "› brew update"
brew update || echo "⚠️  brew update failed, continuing anyway"

# Install homebrew packages
echo "› brew install Brewfile"
if ! brew bundle install --file="$HOMEBREW_DIR/Brewfile"; then
    echo "⚠️  brew bundle install failed, trying individual critical casks"

    # Try to install critical development tools individually
    critical_casks=("intellij-idea" "visual-studio-code" "claude-code" "datagrip")
    for cask in "${critical_casks[@]}"; do
        if ! brew list --cask "$cask" &>/dev/null; then
            echo "  › trying to install $cask individually..."
            if brew install --cask "$cask" 2>&1; then
                echo "    ✅ $cask installed successfully"
            else
                echo "    ⚠️  $cask installation failed - may need manual installation"
            fi
        else
            echo "    ✅ $cask already installed"
        fi
    done

    echo "  You can manually run: brew bundle install --file=\"$HOMEBREW_DIR/Brewfile\""
fi

# Update work configurations if available
if [ -d "$DOTFILES/work" ] && [ -d "$DOTFILES/work/.git" ]; then
    echo "› updating work configurations"
    cd "$DOTFILES/work"
    git pull origin main 2>/dev/null || echo "  work configs update failed (may need authentication)"
    cd "$DOTFILES"
fi

# Install software
echo "› $DOTFILES/install"
if ! $DOTFILES/install; then
    echo "⚠️  Some install scripts may have failed"
    echo "  Check individual install.sh scripts in numbered directories"
else
    echo "✅ All install scripts completed successfully"
fi

# Check for macOS updates that might require restart
if command -v softwareupdate &> /dev/null; then
    echo "› checking for macOS updates"
    if softwareupdate -l 2>/dev/null | grep -q "restart"; then
        echo "⚠️  macOS updates require restart"
        echo "Installation will resume automatically after reboot if resume mechanism is active"
        echo "Run 'bin/dotfiles-resume status' to check resume configuration"
    else
        echo "✅ no macOS updates requiring restart"
    fi
fi
