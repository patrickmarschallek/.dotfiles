#!/usr/bin/env bash
#
# dot
#
# `dot` handles installation, updates, things like that. Run it periodically
# to make sure you're on the latest and greatest.

set -e

parentDirectory="$(cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P)"
dotfilesDirectory="$(cd "$( dirname "$parentDirectory" )" && pwd -P)"

# Source helper functions
source "$dotfilesDirectory/helper.sh"

displayUsageAndExit() {
	echo "dot -- dotfiles management"
	echo ""
	echo "Usage: dot [options]"
	echo ""
	echo "Options:"
	echo "  -e, --edit    Open dotfiles directory for editing"
	echo "  -h, --help    Show this help message and exit"
	exit
}

while test $# -gt 0; do
	case "$1" in
		"-h"|"--help")
			displayUsageAndExit
			;;
		"-e"|"--edit")
			exec "$EDITOR" "$dotfilesDirectory"
			exit
			;;
		*)
			echo "Invalid option: $1"
			displayUsageAndExit
			;;
	esac
	shift
done

export DOTFILES=$HOME/.dotfiles

# Set macOS defaults
echo "â€º setting macOS defaults"
if ! $DOTFILES/00_macos/set-defaults.sh; then
    echo "âš ï¸  macOS defaults setup failed, continuing anyway"
fi

# Install homebrew
echo "â€º installing/updating homebrew"
HOMEBREW_DIR=$DOTFILES/01_homebrew
if ! $HOMEBREW_DIR/install.sh 2>&1; then
    echo "âš ï¸  homebrew installation failed, trying to continue"
fi

# Upgrade homebrew
echo "â€º brew update"
brew update || echo "âš ï¸  brew update failed, continuing anyway"

# Install homebrew packages
echo "â€º brew install Brewfile"
if ! brew bundle install --file="$HOMEBREW_DIR/Brewfile"; then
    echo "âš ï¸  brew bundle install failed, trying individual critical casks"

    # Try to install critical development tools individually
    critical_casks=("intellij-idea" "visual-studio-code" "claude-code" "datagrip")
    for cask in "${critical_casks[@]}"; do
        if ! brew list --cask "$cask" &>/dev/null; then
            echo "  â€º trying to install $cask individually..."
            if brew install --cask "$cask" 2>&1; then
                echo "    âœ… $cask installed successfully"
            else
                echo "    âš ï¸  $cask installation failed - may need manual installation"
            fi
        else
            echo "    âœ… $cask already installed"
        fi
    done

    echo "  You can manually run: brew bundle install --file=\"$HOMEBREW_DIR/Brewfile\""
fi

# Update work configurations if available
if [ -d "$DOTFILES/work" ] && [ -d "$DOTFILES/work/.git" ]; then
    echo "â€º updating work configurations"
    cd "$DOTFILES/work"
    git pull origin main 2>/dev/null || echo "  work configs update failed (may need authentication)"
    cd "$DOTFILES"
fi

# Install software from numbered directories
echo "â€º Running numbered directory installations"
if ! $DOTFILES/install; then
    echo ""
    echo "âš ï¸  Some numbered directory install scripts failed"
    echo "  The install script above shows which ones failed and provides debug commands"
else
    echo ""
    success "All numbered directory installations completed successfully"
fi

# Check for macOS updates that might require restart (non-interactive)
if command -v softwareupdate &> /dev/null; then
    echo "â€º checking for macOS updates"
    # Check if there are any updates available first (without sudo)
    if softwareupdate -l 2>/dev/null | grep -E "(restart|recommended)" | grep -q "restart"; then
        echo "âš ï¸  macOS updates requiring restart are available"
        echo "Installation will resume automatically after reboot if resume mechanism is active"
        echo "Run 'bin/dotfiles-resume status' to check resume configuration"
        echo "Run 'sudo softwareupdate -i -a' to install updates when ready"
    else
        echo "âœ… no critical macOS updates requiring restart"
    fi
fi

echo ""
echo "ğŸ‰ Dotfiles installation completed!"
echo ""
echo "ğŸ“‹ Next Steps:"
echo "  1. Restart your terminal or run: source ~/.zshrc"
echo "  2. If using Hyper terminal, restart it to load new themes/plugins"
echo "  3. Some changes may require logging out and back in"
echo ""
echo "ğŸ”§ Useful Commands:"
echo "  â€¢ bin/dot          - Run this script again to update everything"
echo "  â€¢ bin/dot --edit   - Edit dotfiles configuration"
