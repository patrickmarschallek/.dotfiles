#!/usr/bin/env bash
#
# Run all dotfiles installers with detailed logging.

cd "$(dirname $0)"
DOTFILES_ROOT=$(pwd -P)

source $DOTFILES_ROOT/helper.sh

info "Running numbered directory install scripts"
echo ""

# Track installation results
declare -a successful_installs=()
declare -a failed_installs=()
total_scripts=0

# Find all install scripts and run them with logging
while IFS= read -r -d '' installer; do
    # Extract directory name for display
    dir_name=$(dirname "$installer" | sed 's|^\./||')
    script_name="${dir_name}/install.sh"

    ((total_scripts++))

    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    info "[$total_scripts] Running $script_name"
    echo ""

    # Run the install script and capture the result
    if bash "$installer"; then
        success "âœ… $dir_name installation completed successfully"
        successful_installs+=("$dir_name")
    else
        fail "âŒ $dir_name installation failed"
        failed_installs+=("$dir_name")
        # Continue with other installs even if one fails
    fi
    echo ""

done < <(find . -name install.sh -print0 | sort -z)

# Display final summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
info "ğŸ“‹ Installation Summary"
echo ""
echo "Total scripts executed: $total_scripts"
echo "Successful: ${#successful_installs[@]}"
echo "Failed: ${#failed_installs[@]}"
echo ""

if [ ${#successful_installs[@]} -gt 0 ]; then
    success "âœ… Successful installations:"
    for install in "${successful_installs[@]}"; do
        echo "  â€¢ $install"
    done
    echo ""
fi

if [ ${#failed_installs[@]} -gt 0 ]; then
    fail "âŒ Failed installations:"
    for install in "${failed_installs[@]}"; do
        echo "  â€¢ $install"
    done
    echo ""
    echo "ğŸ’¡ To debug failures, run individual install scripts:"
    for install in "${failed_installs[@]}"; do
        echo "   bash $install/install.sh"
    done
    echo ""

    # Exit with error code if any installations failed
    exit 1
else
    success "ğŸ‰ All installation scripts completed successfully!"
fi
